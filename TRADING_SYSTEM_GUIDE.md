# 🎯 交易系统完整说明

## 系统架构

你的交易系统使用以下理念与固定框架：

### 核心三支柱
1. **价格行为** - 结构识别、支撑阻力
2. **订单流** - 关键位识别、进场区间
3. **缠论** - 趋势结构判定、破坏点确认

### 时间周期
- **20分钟周期**：判定大方向和主趋势（是否多头/空头）
- **5分钟周期**：执行交易信号和具体入场

---

## 🎲 风险管理系统（固定）

### 月度风险限制（核心规则）

**原理：浮动的硬止损**

```
初始资金：$10,000 USDT
↓
月度限额 = 初始资金 × (1 - 6%) = $9,400
↓
无论本月赚多少，都不能亏到 $9,400 以下
如果碰到 $9,400，该月自动停手
```

**下个月重新计算：**
```
假设第一个月赚到 $15,000
→ 下个月初始资金 = $15,000
→ 新月度限额 = $15,000 × 0.94 = $14,100
```

### 每笔交易的风险

**固定 2% 账户资金作为可承受风险**
```
账户余额 $10,000 → 每笔风险 $200（即止损范围内的最大亏损）
杠杆 = 风险金额 / (进场价格 × 止损距离)

例：
  入场价：100 USDT
  止损价：95 USDT（5% 止损距离）
  风险金额：200 USDT
  → 数量 = 200 / (100 × 0.05) = 40
  → 杠杆 = (100 × 40) / 200 = 20 倍
```

---

## 🧠 AI 决策流程

### 你的 AI 现在会做什么？

**第 1 步：趋势判定（20分钟）**
```
检查 EMA-20 vs EMA-50
多头？空头？无方向？
↓
记住：顺大逆小，只在主趋势方向操作
```

**第 2 步：结构识别（5分钟）**
```
寻找以下结构：
- 多转空 / 空转多（趋势反转信号）
- 高点/低点突破（BMS 破坏）
- 回测点（最优进场区）
```

**第 3 步：风险计算**
```
1. 确定止损点（围绕近期高低点）
2. 计算止损距离（%）
3. 算出必要的杠杆倍数
4. 验证是否违反月度限额
```

**第 4 步：下单**
```
如果满足所有条件，AI 自动下单
否则 HOLD（观望）
```

### AI 会记住什么？

系统保存 `trading_memory.json` 文件：

```json
{
  "all_trades": [
    {
      "id": 1,
      "timestamp": "2025-10-30 01:05:00",
      "coin": "BTC",
      "signal": "buy",
      "entry_price": 95000,
      "stop_loss": 92000,
      "structure": "空转多",
      "confidence": 0.85,
      ...
    }
  ],
  "last_trade_logic": { ... }
}
```

**下次决策时，AI 会：**
1. 看到你之前做过什么交易
2. 理解上一笔交易的逻辑
3. 参考当前持仓和亏损情况
4. 做出更智能的决策

---

## 📊 系统输出与文件

日志与数据：
```
outputs/trading_*.log     # 实时交易日志
trading_memory.json       # 交易历史和记忆
```

### 日志内容示例
```
================== 第 1 轮 - 2025-10-30 01:05:00 ==================
✅ OKX 模拟盘连接成功
📅 新月度初始化: 2025-10, 初始资金: $10,000, 回撤底线: $9,400
✅ 月度风险正常，还可亏损: $400 (4.00%)

【BTC 市场分析】
价格: 95000 | 20日EMA: 94500 | RSI(7): 65

BTC: BUY
置信度: 85%
理由: 20分钟空转多，5分钟确认结构突破，支撑位反弹...

✅ 买入成功: 0.105 BTC @ $95000.00
```

---

## 🎛️ 参数调整

检查周期与运行时长（在 `main()` 中）：
```python
trader.run(
    interval_minutes=5,    # 检查间隔（分钟）
    duration_hours=24      # 运行时长（小时）
)
```

### 修改监控币种
在 `crypto_trading_bot_enhanced.py` 初始化处：
```python
self.symbols = [
    'BTC/USDT:USDT',
    'ETH/USDT:USDT',
    # ... 添加或删除
]
```

---

## ⚠️ 重要约束

### 严禁违反
- ❌ 不能改变月度 -6% 的硬止损
- ❌ 不能手动增加单笔持仓超过 20 倍杠杆
- ❌ 不能绕过 2% 风险限制
- ❌ 不能忽视结构未破的规则

### 允许自由选择
- ✅ AI 可以自由选择 1-20 倍杠杆
- ✅ AI 可以自由选择进场时机
- ✅ AI 可以自由定义止损止盈
- ✅ AI 可以根据波动率调整风险

---

## 🚀 启动方式

### 启动
```bash
# 1. 进入项目目录
cd /Users/cuiqingsong/Desktop/222

# 2. 激活虚拟环境
source .venv/bin/activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 运行交易系统
python3 crypto_trading_bot_enhanced.py

# 5. 监控日志（新终端）
tail -f outputs/trading_*.log

# 6. 查看交易记忆
cat trading_memory.json | python3 -m json.tool
```

---

## 📈 关键指标

系统会实时追踪：

| 指标 | 说明 |
|------|------|
| 账户余额 | 当前账户资金 |
| 月度限额 | 该月的硬止损线 |
| 当月亏损 | 距离 -6% 还有多少空间 |
| 胜率 | 当月的盈利笔数占比 |
| 持仓 | 当前开仓的交易 |

---

## 🔍 复盘与优化

每一单完成后，可以查看 `trading_memory.json` 来：

1. **理解 AI 的决策逻辑** - 看 `justification` 字段
2. **分析交易结果** - 看 `pnl` 和 `pnl_pct`
3. **改进策略** - 识别高胜率结构和低胜率陷阱
4. **优化参数** - 根据结果调整 AI 的重点关注指标

---

## 常见问题

### Q: 为什么有时候 AI 不操作？
**A:** 以下情况 AI 会 HOLD（观望）：
- 趋势不明确（EMA 混乱）
- 结构未突破（陷阱信号）
- 可承受风险不足
- 月度限额即将触发

### Q: 如何手动干预？
**A:** 目前系统完全自主。如需干预：
1. 停止脚本（Ctrl+C）
2. 修改 `trading_memory.json`
3. 手动调整持仓
4. 重新启动

### Q: 杠杆为什么不同？
**A:** 根据风险管理公式自动计算：
- 波动大 → 止损距离大 → 杠杆可以更大
- 波动小 → 止损距离小 → 杠杆必须更小
- 月度亏损接近限额 → 杠杆自动降低

---

## 📝 总结

这个系统现在是：
- ✅ **自主决策** - AI 完全根据你的交易体系来决策
- ✅ **有记忆** - 记住所有交易和逻辑
- ✅ **严格风控** - 月度 -6% 硬止损、2% 风险限制
- ✅ **灵活杠杆** - 1-20 倍自动根据波动率调整
- ✅ **持续优化** - 通过交易历史不断学习

**祝你交易顺利！** 🚀
