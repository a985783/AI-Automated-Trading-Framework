# 🎯 风险管理规则 - 完整说明

## 核心原则：以损定仓

你的交易系统基于 **以损定仓** 原则，这是一个理智的风险管理框架。

---

## 📊 两级风险控制

### 第 1 级：单笔交易风险（灵活）

**规则**：每笔交易的风险 = **0.5% ~ 2% 账户资金**

**AI 如何选择**：

| 情景 | 置信度 | 结构清晰度 | 建议风险 |
|------|--------|----------|---------|
| 趋势明确 + 结构清晰 | >80% | 清晰 | 1.5% ~ 2% |
| 趋势一般 + 结构中等 | 60%-80% | 中等 | 0.8% ~ 1.5% |
| 趋势不明 + 结构模糊 | <60% | 模糊 | 0.5% ~ 1% |
| 月度已近 6% 限额 | 任何 | 任何 | 0.5% ~ 1% |

**例子**：
```
账户余额：10,000 USDT

高置信度交易：
  - 可承受风险：200 USDT（2%）
  - 入场价：100 USDT，止损：95 USDT（5%）
  - 仓位：200 / (100 × 0.05) = 40 个单位

低置信度交易：
  - 可承受风险：50 USDT（0.5%）
  - 入场价：100 USDT，止损：95 USDT（5%）
  - 仓位：50 / (100 × 0.05) = 10 个单位
```

### 第 2 级：月度累积风险（硬限制）

**规则**：月度累积亏损 ≤ **初始资金 × 6%**

**特点**：
- 初始资金：月初或系统启动时的账户余额
- 硬止损线：永远不改变（除非下个月）
- 触发条件：账户余额 ≤ 初始资金 × 0.94

**例子**：
```
初始资金：10,000 USDT
月度硬止损线：9,400 USDT

第 1 笔交易亏损 1,000 USDT → 账户 9,000 USDT → 剩余预算 400 USDT
第 2 笔交易亏损 200 USDT → 账户 8,800 USDT → 剩余预算 200 USDT
第 3 笔交易亏损 150 USDT → 账户 8,650 USDT → 剩余预算 50 USDT
第 4 笔想亏 100 USDT → ❌ 拒绝执行（超过 50 USD 预算）

即使第 3 笔赚了 500 USDT，月度限额仍然是 9,400：
  账户变成 9,150 USDT → 离 9,400 还有 250 USD 风险预算
```

---

## ⚙️ 系统执行流程

### 当 AI 做出决策时

```
AI 分析市场
  ↓
AI 返回：{
  "signal": "buy/sell/hold",
  "risk_usd": 150,         ← AI 自主选择（0.5%-2% 范围）
  "leverage": 5,
  "quantity": 10,
  ...
}
  ↓
系统执行【硬限制检查 1】
  检查：risk_usd > 账户 × 2%？
  ❌ 如果超过 → 拒绝，记录警告
  ✅ 如果可以 → 进行下一步
  ↓
系统执行【硬限制检查 2】
  检查：risk_usd > 月度剩余预算？
  ❌ 如果超过 → 拒绝，记录警告
  ✅ 如果可以 → 执行交易
  ↓
交易执行
  记录到 trading_memory.json
```

### 日志示例

成功执行：
```
BTC: BUY
置信度: 85%
✅ 买入成功: 0.5 BTC @ $95000.00
  - 风险: $1000 USD (1.2% 账户)
  - 止损: $92000
  - 止盈: $100000
  - 杠杆: 5x
```

被拒绝（超过单笔限制）：
```
ETH: BUY
置信度: 90%
⛔ ETH 风险 $3000 超过单笔限制 $1663，拒绝执行
  账户 × 2% = 83160 × 0.02 = 1663 USD
```

被拒绝（超过月度预算）：
```
SOL: BUY
置信度: 70%
⛔ SOL 风险 $500 超过月度剩余预算 $200，拒绝执行
  初始：10000, 限额：9400, 当前：9200
  剩余预算：200 USD
```

---

## 🎲 AI 的自由度与约束

### 约束（必须遵守）

| 约束 | 规则 | 类型 |
|------|------|------|
| 单笔最高亏损 | 不超过账户 2% | **硬限制** |
| 月度最高亏损 | 不超过初始资金 6% | **硬限制** |
| 结构规则 | 结构未破不操作 | **交易规则** |
| 趋势规则 | 无方向不操作 | **交易规则** |

### 自由度（AI 可以自主选择）

| 范围 | 灵活性 |
|------|--------|
| 单笔风险 | 0.5% ~ 2% (在硬限制内灵活) |
| 杠杆倍数 | 1 ~ 20 倍 |
| 进场时机 | 完全自主（基于结构） |
| 币种选择 | 可以选择 HOLD 任何币种 |
| 是否操作 | 可以选择不操作 |

---

## 📈 风险金额计算公式

```
risk_usd = 账户余额 × 风险百分比（0.5% ~ 2%）
quantity = risk_usd / (entry_price × stop_loss_distance%)
leverage = (entry_price × quantity) / (risk_usd / stop_loss_distance%)
```

**例子**：
```
账户：10000 USDT
风险选择：1.5%（中等置信度）
risk_usd = 10000 × 0.015 = 150 USD

BTC 当前价：95000
止损价：92000（止损距离：3.16%）

quantity = 150 / (95000 × 0.0316) = 0.05 BTC
杠杆 = (95000 × 0.05) / 150 = ~31.67x

❌ 等等，这样杠杆太高了！
让我们把杠杆限在 10x：
actual_quantity = (150 × 10 / (95000 × 0.0316)) = 0.5 BTC
```

---

## 💡 AI 决策逻辑示例

### 场景 1：高确定性交易

```json
{
  "signal": "buy",
  "structure": "空转多",
  "trend_20m": "上升",
  "confidence": 0.88,
  "structure_clarity": "清晰",
  "entry_price": 95000,
  "stop_loss": 92500,
  "profit_target": 100000,
  "stop_loss_distance_pct": 0.0263,

  "risk_usd": 1800,      ← 选择接近 2% 上限（账户 × 0.02 = 1663，AI 谨慎选 1800 以内）
  "risk_pct": 1.8,
  "leverage": 10,
  "quantity": 6.8,

  "justification": "20分钟上升趋势确认，5分钟出现空转多结构...止损点明确...高置信度，可用 1.8% 风险..."
}
```

### 场景 2：中等确定性交易

```json
{
  "signal": "buy",
  "structure": "回测",
  "trend_20m": "上升",
  "confidence": 0.65,
  "structure_clarity": "中等",
  "entry_price": 95000,
  "stop_loss": 93500,
  "profit_target": 98000,
  "stop_loss_distance_pct": 0.0158,

  "risk_usd": 1050,      ← 选择 1% 左右（中等置信度）
  "risk_pct": 1.0,
  "leverage": 6,
  "quantity": 11.2,

  "justification": "趋势确认但信号不强...止损点需谨慎...中等置信度，用 1% 风险"
}
```

### 场景 3：低确定性或无机会

```json
{
  "signal": "hold",
  "structure": "观望",
  "trend_20m": "无方向",
  "confidence": 0.4,
  "structure_clarity": "模糊",

  "justification": "20分钟 EMA 混乱，无明确趋势...结构不清...放弃本轮，继续观望"
}
```

---

## 🛡️ 保护机制

### 系统确保的保护

1. **单笔亏损上限**
   - 即使 AI 尝试提交超过 2% 的风险
   - 系统会自动拒绝并记录警告

2. **月度总亏损上限**
   - 即使多笔小亏损累积
   - 系统会防止超过月度 6% 限额
   - 触发时自动停止交易

3. **以损定仓弹性**
   - AI 不被强制固定风险
   - 可以根据实时情况灵活选择
   - 高置信度敢赚，低置信度少赚

### 用户需要做的

- ✅ 定期查看 `trading_memory.json` 了解 AI 的决策逻辑
- ✅ 检查日志中的拒绝记录，理解为什么某些交易被拒绝
- ✅ 根据胜率调整 AI 的置信度权重
- ✅ 观察 AI 在不同市场环境下的表现

---

## 📊 月度数据示例

```
初始资金：10,000 USD
月度限额：9,400 USD

第 1 周：
  交易 1：赚 200 USD  → 账户 10,200 USD
  交易 2：亏 150 USD  → 账户 10,050 USD

第 2 周：
  交易 3：亏 300 USD  → 账户 9,750 USD
  交易 4：赚 100 USD  → 账户 9,850 USD

第 3 周：
  交易 5：亏 250 USD  → 账户 9,600 USD

此时：
  - 初始：10,000
  - 当前：9,600
  - 亏损：400 USD（4% 月度亏损）
  - 剩余预算：400 - 400 = 0 USD

第 4 周：
  系统自动降低风险到 0.5%-1% 范围（剩余预算接近 0）
  或拒绝新交易，只管理已有持仓
```

---

## ✅ 总结

你的系统现在有：

1. **灵活的单笔风险** - AI 根据置信度在 0.5%-2% 间选择
2. **严格的月度上限** - 永远不能亏超 6%
3. **智能执行层** - 强制检查所有决策是否遵守硬限制
4. **完整的记忆** - 所有决策都被记录和分析

这是一个 **既给 AI 自由度又保护账户的完美平衡**。

---

*最后更新：2025-10-30*
